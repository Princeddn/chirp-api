<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Dashboard LoRa</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 20px; }
    pre { margin: 0; }
    .alarm { background-color: #ffcccc !important; }
  </style>
</head>
<body class="container">
  <h1 class="mt-4 mb-4">📡 Dashboard Capteurs LoRa</h1>

  <div class="mb-3">
    <button class="btn btn-outline-primary me-2" onclick="location.href='/uplink?format=json'">📄 JSON</button>
    <button class="btn btn-outline-success me-2" onclick="location.href='/uplink?format=csv'">⬇️ Export CSV</button>
    <button class="btn btn-outline-info" onclick="lancerBackup()">💾 Sauvegarde GitHub</button>
  </div>

  <!-- Filtres capteur, grandeur -->
  <div class="row mb-3">
    <div class="col-md-4">
      <label>🔧 Capteur:</label>
      <select id="capteur" class="form-select" onchange="updateGrandeurs()">
        <option value="all">Tous</option>
        {% for c in capteurs %}
          <option value="{{c}}">{{c}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label>🌡️ Grandeur:</label>
      <select id="grandeur" class="form-select">
        <option value="">Sélectionnez d'abord un capteur</option>
      </select>
    </div>
  </div>

  <!-- Filtres date/heure -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label>🕒 Début :</label>
      <input type="datetime-local" id="start-time" class="form-control">
    </div>
    <div class="col-md-3">
      <label>🕒 Fin :</label>
      <input type="datetime-local" id="end-time" class="form-control">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-outline-primary" onclick="updateChart()">🔄 Afficher la courbe</button>
    </div>
  </div>

  <!-- Graphique -->
  <canvas id="chart" style="max-width: 100%; height: 300px;"></canvas>

  <!-- Tableau -->
  <h3 class="mt-4">📋 Données Reçues (auto-refresh)</h3>
  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>Horodatage</th>
        <th>Capteur</th>
        <th>Fabricant</th>
        <th>Payload</th>
        <th>Données décodées</th>
      </tr>
    </thead>
    <tbody id="sensor-tbody"></tbody>
  </table>

  <!-- Scripts -->
  <script>
    let chart;

    async function loadData() {
      const res = await fetch('/uplink?format=json');
      return await res.json();
    }

    async function autoRefresh() {
      await refreshTable();
      setTimeout(autoRefresh, 10000);
    }

    async function refreshTable() {
      const data = await loadData();
      const tbody = document.getElementById('sensor-tbody');
      tbody.innerHTML = '';

      data.forEach(d => {
        const tr = document.createElement('tr');
        if (d.decoded?.co2?.value > 1000) tr.classList.add('alarm');

        tr.innerHTML = `
          <td>${d.timestamp || ''}</td>
          <td>${d.deviceInfo?.deviceName || ''}</td>
          <td>${d.decoded?.Fabricant || 'N/A'}</td>
          <td><pre>${d.data || ''}</pre></td>
          <td><pre>${JSON.stringify(d.decoded, null, 2)}</pre></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function updateGrandeurs() {
      const capteur = document.getElementById("capteur").value;
      const grandeurSelect = document.getElementById("grandeur");
      grandeurSelect.innerHTML = '';

      if (!capteur || capteur === "all") {
        grandeurSelect.innerHTML = '<option value="">Sélectionnez d\'abord un capteur</option>';
        return;
      }

      const data = await loadData();
      const filtered = data.filter(d => d.deviceInfo?.deviceName === capteur);
      const grandeursSet = new Set();

      filtered.forEach(d => {
        if (d.decoded) {
          Object.keys(d.decoded).forEach(gr => {
            if (typeof d.decoded[gr] === 'object' && d.decoded[gr]?.value !== undefined) {
              grandeursSet.add(gr);
            }
          });
        }
      });

      if (grandeursSet.size > 0) {
        grandeurSelect.innerHTML = '<option value="">Choisissez une grandeur</option>';
        grandeursSet.forEach(gr => {
          const opt = document.createElement("option");
          opt.value = gr;
          opt.textContent = gr;
          grandeurSelect.appendChild(opt);
        });
      } else {
        grandeurSelect.innerHTML = '<option>Aucune grandeur disponible</option>';
      }
    }

    async function updateChart() {
      const capteur = document.getElementById("capteur").value;
      const grandeur = document.getElementById("grandeur").value;
      const start = document.getElementById("start-time").value;
      const end = document.getElementById("end-time").value;

      if (!capteur || !grandeur) {
        alert("Sélectionne un capteur et une grandeur avant d'afficher la courbe.");
        return;
      }

      const data = await loadData();

      const filtered = data.filter(d => {
        const ts = new Date(d.timestamp);
        const matchCapteur = (capteur === "all" || d.deviceInfo?.deviceName === capteur);
        const hasValue = d.decoded?.[grandeur]?.value !== undefined;
        const inTime = (!start || ts >= new Date(start)) && (!end || ts <= new Date(end));
        return matchCapteur && hasValue && inTime;
      });

      if (filtered.length === 0) {
        alert("Aucune donnée pour cette sélection.");
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.update();
        return;
      }

      chart.data.labels = filtered.map(d => d.timestamp);
      chart.data.datasets[0].label = grandeur;
      chart.data.datasets[0].data = filtered.map(d => d.decoded[grandeur].value);
      chart.update();
    }

    async function lancerBackup() {
      const res = await fetch("/uplink?event=push", { method: "POST" });
      const result = await res.json();
      alert(result.status);
    }

    window.onload = async function () {
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Valeur', data: [], borderColor: 'blue', borderWidth: 2 }] },
        options: { responsive: true }
      });
      await refreshTable();
      autoRefresh();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
