<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Dashboard LoRa OptimisÃ©</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
      body { margin: 20px; }
      pre { margin: 0; }
      .alarm { background-color: #ffcccc !important; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chart;
        async function loadData() {
            const res = await fetch('/uplink?format=json');
            return await res.json();
        }

        // RafraÃ®chit le tableau toutes les X secondes
        async function autoRefresh() {
            await refreshTable();
            setTimeout(autoRefresh, 10000); // toutes les 10s
        }

        async function refreshTable() {
            const data = await loadData();
            const tbody = document.getElementById('sensor-tbody');
            tbody.innerHTML = '';

            data.forEach(d => {
                const tr = document.createElement('tr');

                // Check alarme co2
                if (d.decoded?.co2?.value > 1000) {
                   tr.classList.add('alarm');
                }

                const tdTime = document.createElement('td');
                tdTime.innerHTML = d.timestamp || '';
                tr.appendChild(tdTime);

                const tdDevice = document.createElement('td');
                tdDevice.innerHTML = d.deviceInfo?.deviceName || '';
                tr.appendChild(tdDevice);

                const tdData = document.createElement('td');
                tdData.innerHTML = '<pre>'+(d.data || '')+'</pre>';
                tr.appendChild(tdData);

                const tdDecoded = document.createElement('td');
                tdDecoded.innerHTML = '<pre>'+JSON.stringify(d.decoded, null, 2)+'</pre>';
                tr.appendChild(tdDecoded);

                tbody.appendChild(tr);
            });
        }

        async function updateChart() {
            const capteur = document.getElementById("capteur").value;
            const grandeur = document.getElementById("grandeur").value;
            const data = await loadData();
            const filtered = data.filter(d =>
                (capteur === "all" || d.deviceInfo?.deviceName === capteur) &&
                d.decoded?.[grandeur]?.value !== undefined
            );
            const labels = filtered.map(d => d.timestamp);
            const vals = filtered.map(d => d.decoded[grandeur].value);

            chart.data.labels = labels;
            chart.data.datasets[0].label = grandeur;
            chart.data.datasets[0].data = vals;
            chart.update();
        }

        async function lancerBackup() {
            const res = await fetch("/uplink?event=push", { method: "POST" });
            const result = await res.json();
            alert(result.status);
        }

        window.onload = async function() {
            // Initial chart
            const ctx = document.getElementById('chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Valeur',
                        data: [],
                        borderColor: 'blue',
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    responsive: true
                }
            });

            // Premier refresh
            await refreshTable();
            // auto refresh
            autoRefresh();
        }
    </script>
</head>
<body class="container">
    <h1 class="mt-4 mb-4">ğŸ“¡ Dashboard Capteurs LoRa (OptimisÃ©)</h1>
    <div class="mb-3">
        <button class="btn btn-outline-primary me-2" onclick="location.href='/uplink?format=json'">ğŸ“„ JSON</button>
        <button class="btn btn-outline-success me-2" onclick="location.href='/uplink?format=csv'">â¬‡ï¸ Export CSV</button>
        <button class="btn btn-outline-info" onclick="lancerBackup()">ğŸ’¾ Sauvegarde GitHub</button>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        <label>ğŸ”§ Capteur:</label>
        <select id="capteur" class="form-select">
            <option value="all">Tous</option>
            {% for c in capteurs %}
                <option value="{{c}}">{{c}}</option>
            {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label>ğŸŒ¡ï¸ Grandeur:</label>
        <select id="grandeur" class="form-select">
            {% for g in grandeurs %}
                <option value="{{g}}">{{g}}</option>
            {% endfor %}
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-outline-primary" onclick="updateChart()">ğŸ”„ Courbe</button>
      </div>
    </div>

    <canvas id="chart" style="max-width: 100%; height: 300px;"></canvas>

    <h3 class="mt-4">ğŸ“‹ DonnÃ©es ReÃ§ues (auto-refresh)</h3>
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Horodatage</th>
                <th>Capteur</th>
                <th>Fabricant</th>
                <th>Payload</th>
                <th>DonnÃ©es dÃ©codÃ©es</th>
            </tr>
        </thead>
        <tbody id="sensor-tbody">
        </tbody>
    </table>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
