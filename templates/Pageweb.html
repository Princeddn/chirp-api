<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Dashboard LoRa</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 20px; }
    pre { margin: 0; }
    .alarm { background-color: #ffcccc !important; }
  </style>
</head>
<body class="container">
  <h1 class="mt-4 mb-4">üì± Dashboard Capteurs LoRa</h1>

  <div class="mb-3">
    <button class="btn btn-outline-primary me-2" onclick="location.href='/uplink?format=json'">üìÑ JSON</button>
    <button class="btn btn-outline-success me-2" onclick="location.href='/uplink?format=csv'">‚¨áÔ∏è Export CSV</button>
    <button class="btn btn-outline-info me-2" onclick="lancerBackup()">üìÖ Sauvegarde GitHub</button>
    <span class="badge bg-secondary" id="nb-trames">0 trames affich√©es</span>
  </div>

  <div class="card p-3 mb-3">
    <div class="row">
      <div class="col-md-4">
        <label>üîß Capteur :</label>
        <select id="capteur" class="form-select" onchange="updateGrandeurs()">
          <option value="all">Tous</option>
          {% for c in capteurs %}
            <option value="{{c}}">{{c}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label>üìä Grandeurs (multi-s√©lection) :</label>
        <select id="grandeur" class="form-select" multiple></select>
      </div>
      <div class="col-md-4">
        <label>üïí P√©riode :</label>
        <div class="d-flex">
          <input type="datetime-local" id="start-time" class="form-control me-2">
          <input type="datetime-local" id="end-time" class="form-control">
        </div>
      </div>
    </div>
    <div class="mt-3 d-flex justify-content-end gap-2">
      <button class="btn btn-outline-primary" onclick="updateChart()">üîÑ Afficher la courbe</button>
      <button class="btn btn-outline-danger" onclick="resetFilters()">‚ôªÔ∏è R√©initialiser</button>
    </div>
  </div>

  <canvas id="chart" style="max-width: 100%; height: 300px;"></canvas>

  <div class="card p-3 mt-4">
    <h4>üìã Donn√©es Re√ßues (auto-refresh)</h4>
    <table class="table table-bordered mt-2">
      <thead class="table-light">
        <tr>
          <th>Horodatage</th>
          <th>Capteur</th>
          <th>Fabricant</th>
          <th>Payload</th>
          <th>Donn√©es d√©cod√©es</th>
        </tr>
      </thead>
      <tbody id="sensor-tbody"></tbody>
    </table>
  </div>

  <script>
    let chart;

    async function loadData() {
      const res = await fetch('/uplink?format=json');
      return await res.json();
    }

    async function autoRefresh() {
      await refreshTable();
      setTimeout(autoRefresh, 10000);
    }

    async function refreshTable() {
      const data = await loadData();
      const tbody = document.getElementById('sensor-tbody');
      tbody.innerHTML = '';

      data.forEach(d => {
        const tr = document.createElement('tr');
        if (d.decoded?.co2?.value > 1000) tr.classList.add('alarm');
        tr.innerHTML = `
          <td>${d.timestamp || ''}</td>
          <td>${d.deviceInfo?.deviceName || ''}</td>
          <td>${d.decoded?.Fabricant || 'N/A'}</td>
          <td><pre>${d.data || ''}</pre></td>
          <td><pre>${JSON.stringify(d.decoded, null, 2)}</pre></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function resetFilters() {
      document.getElementById("capteur").value = "all";
      document.getElementById("grandeur").innerHTML = '';
      document.getElementById("start-time").value = "";
      document.getElementById("end-time").value = "";
      chart.data.labels = [];
      chart.data.datasets = [];
      chart.update();
    }

    async function updateGrandeurs() {
      const capteur = document.getElementById("capteur").value;
      const grandeurSelect = document.getElementById("grandeur");
      grandeurSelect.innerHTML = '';

      if (!capteur || capteur === "all") {
        grandeurSelect.innerHTML = '<option disabled>S√©lectionnez un capteur</option>';
        return;
      }

      const data = await loadData();
      const filtered = data.filter(d => d.deviceInfo?.deviceName === capteur);
      const grandeursSet = new Set();

      filtered.forEach(d => {
        if (d.decoded) {
          Object.entries(d.decoded).forEach(([key, val]) => {
            if (typeof val === 'object' && 'value' in val) {
              grandeursSet.add(key);
            }
          });
        }
      });

      grandeursSet.forEach(gr => {
        const opt = document.createElement("option");
        opt.value = gr;
        opt.textContent = gr;
        grandeurSelect.appendChild(opt);
      });
    }

    async function updateChart() {
      const capteur = document.getElementById("capteur").value;
      const grandeurs = Array.from(document.getElementById("grandeur").selectedOptions).map(opt => opt.value);
      const start = document.getElementById("start-time").value;
      const end = document.getElementById("end-time").value;

      if (!capteur || grandeurs.length === 0) {
        alert("S√©lectionne un capteur et au moins une grandeur.");
        return;
      }

      const data = await loadData();
      const filtered = data.filter(d => {
        const ts = new Date(d.timestamp);
        const inCapteur = (capteur === "all" || d.deviceInfo?.deviceName === capteur);
        const inTimeRange = (!start || ts >= new Date(start)) && (!end || ts <= new Date(end));
        return inCapteur && inTimeRange;
      });

      document.getElementById("nb-trames").textContent = `${filtered.length} trames affich√©es`;

      if (filtered.length === 0) {
        alert("Aucune donn√©e trouv√©e.");
        chart.data.labels = [];
        chart.data.datasets = [];
        chart.update();
        return;
      }

      const labels = filtered.map(d => d.timestamp);
      const datasets = grandeurs.map((g, idx) => ({
        label: g,
        data: filtered.map(d => d.decoded?.[g]?.value ?? null),
        borderColor: getColor(idx),
        fill: false,
        tension: 0.2
      }));

      chart.data.labels = labels;
      chart.data.datasets = datasets;
      chart.update();
    }

    function getColor(i) {
      const colors = ['#007bff', '#dc3545', '#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14'];
      return colors[i % colors.length];
    }

    async function lancerBackup() {
      const res = await fetch("/uplink?event=push", { method: "POST" });
      const result = await res.json();
      alert(result.status);
    }

    window.onload = async function () {
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  return `${ctx.dataset.label}: ${ctx.formattedValue}`;
                }
              }
            }
          },
          scales: {
            y: { beginAtZero: false }
          }
        }
      });

      await refreshTable();
      autoRefresh();
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
