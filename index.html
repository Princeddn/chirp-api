<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard LoRa</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #64748b;
      --success-color: #059669;
      --warning-color: #d97706;
      --danger-color: #dc2626;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-shadow: 0 10px 25px rgba(0,0,0,0.1);
      --border-radius: 12px;
    }

    body {
      background: var(--bg-gradient);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .container {
      background: rgba(255,255,255,0.95);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(10px);
      padding: 30px;
      margin-top: 20px;
    }

    h1 {
      color: var(--primary-color);
      font-weight: 600;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .nav-tabs {
      border: none;
      background: #f8fafc;
      border-radius: var(--border-radius);
      padding: 8px;
    }

    .nav-tabs .nav-link {
      border: none;
      border-radius: 8px;
      color: var(--secondary-color);
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 0 4px;
    }

    .nav-tabs .nav-link:hover {
      background: rgba(37,99,235,0.1);
      color: var(--primary-color);
    }

    .nav-tabs .nav-link.active {
      background: var(--primary-color);
      color: white;
      box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    }

    .card {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .btn {
      border-radius: 8px;
      font-weight: 500;
      padding: 8px 16px;
      transition: all 0.3s ease;
      border: none;
    }

    .btn-outline-primary {
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline-primary:hover {
      background: var(--primary-color);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(37,99,235,0.3);
    }

    .btn-outline-secondary {
      border: 2px solid var(--secondary-color);
      color: var(--secondary-color);
    }

    .btn-outline-success {
      border: 2px solid var(--success-color);
      color: var(--success-color);
    }

    .btn-outline-info {
      border: 2px solid #0ea5e9;
      color: #0ea5e9;
    }

    .btn-outline-danger {
      border: 2px solid var(--danger-color);
      color: var(--danger-color);
    }

    .form-control, .form-select {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px 12px;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
    }

    .badge {
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 0.9em;
    }

    .table {
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .table thead th {
      background: var(--primary-color);
      color: white;
      border: none;
      font-weight: 600;
      padding: 15px;
    }

    .table tbody td {
      padding: 12px 15px;
      border-color: #f1f5f9;
    }

    .alarm {
      background: linear-gradient(90deg, #fee2e2, #fecaca) !important;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .pagination .page-link {
      border: none;
      border-radius: 8px;
      margin: 0 2px;
      color: var(--primary-color);
      font-weight: 500;
    }

    .pagination .page-item.active .page-link {
      background: var(--primary-color);
      box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    }

    .alert {
      border: none;
      border-radius: var(--border-radius);
      border-left: 4px solid var(--warning-color);
    }

    #chart {
      border-radius: var(--border-radius);
      background: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    pre {
      background: #f8fafc;
      border-radius: 6px;
      padding: 8px;
      margin: 0;
      border: 1px solid #e2e8f0;
      font-size: 0.85em;
    }

    .text-muted {
      color: var(--secondary-color) !important;
    }

    #grandeur-checkboxes .form-check {
      margin-right: 15px;
      margin-bottom: 8px;
    }

    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .gap-3 {
      gap: 1rem !important;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(37,99,235,.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="container">

  <h1 class="mb-4">üì° Dashboard Capteurs LoRa</h1>
  <div id="message-container" class="alert alert-warning d-none" role="alert"></div>

  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="total-sensors">-</div>
      <div class="stat-label">Capteurs Actifs</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="total-data">-</div>
      <div class="stat-label">Donn√©es Totales</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="last-received">-</div>
      <div class="stat-label">Derni√®re R√©ception</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="status-indicator">üü¢</div>
      <div class="stat-label">Statut Syst√®me</div>
    </div>
  </div>

  <ul class="nav nav-tabs mb-4" id="myTabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#graphe">üìä Graphe</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tableau">üìã Tableau</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#export">üìÑ Exportation</a></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="graphe">
      <div class="mb-3 d-flex flex-wrap align-items-center gap-3">
        <span class="badge bg-secondary" id="nb-trames">0 trames affich√©es</span>
        <span class="text-muted" id="last-update">Derni√®re mise √† jour : --</span>
        <span class="loading d-none" id="loading-indicator"></span>
      </div>

      <div class="card p-3 mb-3">
        <div class="row">
          <div class="col-md-3">
            <label>üîß Nom du capteur :</label>
            <select id="capteur" class="form-select" onchange="updateGrandeurs()">
              <option value="all">Tous</option>
            </select>
          </div>
          <div class="col-md-3">
            <label>üìà Grandeurs :</label>
            <div id="grandeur-checkboxes" class="form-check d-flex flex-wrap gap-2"></div>
          </div>
          <div class="col-md-4">
            <label>üïí P√©riode :</label>
            <div class="d-flex">
              <input type="datetime-local" id="start-time" class="form-control me-2">
              <input type="datetime-local" id="end-time" class="form-control">
            </div>
            <div class="d-flex mt-2 flex-wrap gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="setToday()">Aujourd'hui</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="clearDates()">Effacer dates</button>
            </div>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-outline-primary w-100" onclick="updateChart()">üîÑ Afficher la courbe</button>
          </div>
        </div>
        <div class="mt-3 d-flex justify-content-end gap-2">
          <button class="btn btn-outline-danger" onclick="resetFilters()">‚ôªÔ∏è R√©initialiser</button>
          <button class="btn btn-outline-info" onclick="exportChart()">üì∑ Exporter le graphique</button>
        </div>
      </div>

      <canvas id="chart" style="max-width: 100%; height: 300px;"></canvas>
    </div>

    <div class="tab-pane fade" id="tableau">
      <div class="card p-3">
        <h4>üìã Donn√©es Re√ßues </h4>
        <table class="table table-bordered mt-2">
          <thead class="table-light">
            <tr>
              <th>Horodatage</th>
              <th>Nom du Capteur</th>
              <th>Type</th>
              <th>Fabricant</th>
              <th>Payload</th>
              <th>Donn√©es d√©cod√©es</th>
            </tr>
          </thead>
          <tbody id="sensor-tbody"></tbody>
        </table>
        <nav><ul class="pagination" id="pagination"></ul></nav>
      </div>
    </div>

    <div class="tab-pane fade" id="export">
      <div class="card p-3">
        <h4>üì§ Exportation & Sauvegarde</h4>
        <div class="d-flex gap-3 flex-wrap">
          <button class="btn btn-outline-primary" onclick="location.href='database.json'">üìÑ JSON</button>
          <button class="btn btn-outline-success" onclick="exportCSV()">‚¨áÔ∏è CSV</button>
          <button class="btn btn-outline-info" disabled title="Indisponible sur GitHub Pages">üíæ Sauvegarde GitHub</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let chart, currentData = [], rowsPerPage = 10, currentPage = 1;

    function toUTCDateFromLocalInput(dateStr) {
      return dateStr ? new Date(dateStr) : null;
    }

    function parseFlexibleDate(input) {
      const iso = Date.parse(input);
      if (!isNaN(iso)) return new Date(iso);
      const cleaned = input.replace(/ CEST| CET| UTC| GMT.*$/, '');
      const attempt = new Date(cleaned);
      return isNaN(attempt) ? null : attempt;
    }

    function showMessage(msg) {
      const container = document.getElementById("message-container");
      container.classList.remove("d-none");
      container.textContent = msg;
      setTimeout(() => container.classList.add("d-none"), 5000);
    }

    async function loadData() {
      const res = await fetch('database.json', { cache: 'no-store' });
      return await res.json();
    }

    function updateStats(data) {
      // Nombre de capteurs uniques
      const sensors = new Set();
      data.forEach(d => {
        const name = d?.deviceInfo?.deviceName;
        if (name) sensors.add(name);
      });
      document.getElementById('total-sensors').textContent = sensors.size;

      // Nombre total de donn√©es
      document.getElementById('total-data').textContent = data.length.toLocaleString();

      // Derni√®re r√©ception
      if (data.length > 0) {
        const latest = data.reduce((latest, current) => {
          const currentTime = new Date(current.timestamp);
          const latestTime = new Date(latest.timestamp);
          return currentTime > latestTime ? current : latest;
        });
        const timeAgo = getTimeAgo(new Date(latest.timestamp));
        document.getElementById('last-received').textContent = timeAgo;
      }

      // Statut (bas√© sur la r√©cence des donn√©es)
      const now = new Date();
      const oneHour = 60 * 60 * 1000;
      const recentData = data.filter(d => {
        const dataTime = new Date(d.timestamp);
        return (now - dataTime) < oneHour;
      });

      if (recentData.length > 0) {
        document.getElementById('status-indicator').textContent = 'üü¢';
      } else {
        document.getElementById('status-indicator').textContent = 'üü°';
      }
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / (1000 * 60));
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (minutes < 60) return `${minutes}min`;
      if (hours < 24) return `${hours}h`;
      return `${days}j`;
    }

    function safeDateLabel(str) {
      const cleaned = str.replace(/( CEST| CET| UTC| GMT.*)$/, '').replace(' ', 'T');
      const date = new Date(cleaned);
      return isNaN(date.getTime()) ? "Date invalide" : date.toLocaleString("fr-FR", { hour12: false });
    }

    async function updateChart() {
      const capteur   = document.getElementById("capteur").value;
      const startDate = toUTCDateFromLocalInput(document.getElementById("start-time").value);
      const endDate   = toUTCDateFromLocalInput(document.getElementById("end-time").value);
      const selected  = Array.from(document.querySelectorAll("#grandeur-checkboxes input:checked"))
                              .map(cb => cb.value);

      if (!capteur || selected.length === 0) {
        showMessage("S√©lectionne un capteur et au moins une grandeur.");
        return;
      }

      const data     = await loadData();
      const filtered = data.filter(d => {
        const ts = parseFlexibleDate(d.timestamp);
        if (!ts) return false;
        const okDate = (!startDate || ts >= startDate) && (!endDate || ts <= endDate);
        const okCap  = capteur === "all" || d.deviceInfo?.deviceName === capteur;
        return okDate && okCap;
      });

      if (filtered.length === 0) {
        showMessage("Aucune donn√©e trouv√©e pour cette p√©riode ou ce capteur.");
        return;
      }

      const datasets = selected.map((g, i) => {
        const rawPts = filtered
          .map(d => {
            const ts  = parseFlexibleDate(d.timestamp);
            const raw = d.decoded?.[g];
            const y   = (raw && typeof raw === 'object') ? raw.value : raw;
            return (ts && typeof y === 'number') ? { x: ts, y } : null;
          })
          .filter(p => p !== null && p.y >= 0)
          .sort((a, b) => a.x - b.x);

        // Filtrage des variations extr√™mes
        const maxDelta = 200;
        const pts = rawPts.filter((p,i, arr) =>{
          if (i===0) return true;
          return Math.abs(p.y - arr[i-1].y) <= maxDelta;
        });

        const values = pts.map(p => p.y);
        const min    = Math.min(...values);
        const max    = Math.max(...values);
        const avg    = values.reduce((sum, v) => sum + v, 0) / values.length;

        return {
          label: `${g} (min : ${min.toFixed(2)}, moy : ${avg.toFixed(2)}, max : ${max.toFixed(2)})`,
          data: pts,
          borderColor: getColor(i),
          fill: false,
          tension: 0.3
        };
      });

      chart.data.datasets = datasets;
      chart.update();

      document.getElementById("nb-trames").textContent =
        `${filtered.length} / ${data.length} trames affich√©es`;
      document.getElementById("last-update").textContent =
        "Derni√®re mise √† jour : " + new Date().toLocaleString('fr-FR');
    }

    function clearDates() {
      document.getElementById("start-time").value = "";
      document.getElementById("end-time").value = "";
    }

    function setToday() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');

      const start = `${yyyy}-${mm}-${dd}T00:00`;
      const end = `${yyyy}-${mm}-${dd}T23:59`;

      document.getElementById("start-time").value = start;
      document.getElementById("end-time").value = end;
    }

    function exportChart() {
      const link = document.createElement('a');
      link.download = "graphique-lora.png";
      link.href = chart.toBase64Image();
      link.click();
    }

    function populateCapteursFromCurrentData() {
      const select = document.getElementById("capteur");
      const seen = new Set();
      (currentData || []).forEach(d => {
        const name = d?.deviceInfo?.deviceName;
        if (name && !seen.has(name)) {
          seen.add(name);
          const opt = document.createElement("option");
          opt.value = name; opt.textContent = name;
          select.appendChild(opt);
        }
      });
    }

    function resetFilters() {
      document.getElementById("capteur").value = "all";
      clearDates();
      document.getElementById("grandeur-checkboxes").innerHTML = "";
      chart.data.datasets = [];
      chart.update();
    }

    async function refreshTable() {
      const loading = document.getElementById('loading-indicator');
      loading.classList.remove('d-none');

      try {
        const prevPage = currentPage;
        currentData = await loadData();
        updateStats(currentData);
        renderPage(prevPage);
      } finally {
        loading.classList.add('d-none');
      }
    }

    function exportCSV() {
      if (!Array.isArray(currentData) || currentData.length === 0) {
        showMessage("Aucune donn√©e √† exporter.");
        return;
      }
      const header = ["timestamp","Nom du capteur","Product_type","Fabricant","data","decoded"];
      const rows = currentData.map(row => {
        const decoded = row.decoded || {};
        const product = decoded.Product_type ?? "Inconnu";
        const devName = row.deviceInfo?.deviceName ?? "Inconnu";
        const fabricant = decoded.Fabricant ?? "N/A";
        const payload = row.data ?? "";
        const decodedStr = JSON.stringify(decoded).replace(/\n/g," ");
        return [
          row.timestamp ?? "",
          devName,
          product,
          fabricant,
          payload,
          decodedStr
        ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(",");
      });
      const csv = [header.join(","), ...rows].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "export.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    function renderPage(page) {
      const tbody = document.getElementById('sensor-tbody');
      const pagination = document.getElementById('pagination');
      tbody.innerHTML = '';
      pagination.innerHTML = '';
      const totalPages = Math.ceil(currentData.length / rowsPerPage);
      currentPage = Math.min(Math.max(1, page), totalPages);
      const start = (currentPage - 1) * rowsPerPage;
      const visible = currentData.slice(start, start + rowsPerPage);

      visible.forEach(d => {
        const tr = document.createElement('tr');
        if (d.decoded?.co2?.value > 1000) tr.classList.add('alarm');
        tr.innerHTML = `
          <td>${safeDateLabel(d.timestamp)}</td>
          <td>${d.deviceInfo?.deviceName || 'Inconnu'}</td>
          <td>${d.decoded?.Product_type || 'Inconnu'}</td>
          <td>${d.decoded?.Fabricant || 'N/A'}</td>
          <td><pre>${d.data || ''}</pre></td>
          <td><pre>${JSON.stringify(d.decoded, null, 2)}</pre></td>
        `;
        tbody.appendChild(tr);
      });

      // Pagination
      const prevLi = document.createElement('li');
      prevLi.className = 'page-item'+(currentPage===1?' disabled':'');
      prevLi.innerHTML = `<a class="page-link" href="#">Pr√©c√©dent</a>`;
      prevLi.onclick = ()=> currentPage>1 && renderPage(currentPage-1);
      pagination.appendChild(prevLi);

      const maxBtns = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxBtns/2));
      let endPage = Math.min(totalPages, startPage + maxBtns - 1);
      if (endPage - startPage < maxBtns-1) startPage = Math.max(1, endPage - maxBtns + 1);

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = 'page-item'+(i===currentPage?' active':'');
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = ()=> renderPage(i);
        pagination.appendChild(li);
      }

      const next = document.createElement('li');
      next.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
      next.innerHTML = `<a class="page-link" href="#">Suivant</a>`;
      next.onclick = () => currentPage < totalPages && renderPage(currentPage + 1);
      pagination.appendChild(next);

      document.getElementById("nb-trames").textContent = `${currentData.length} trames affich√©es`;
      document.getElementById("last-update").textContent = "Derni√®re mise √† jour : " + new Date().toLocaleString('fr-FR');
    }

    async function updateGrandeurs() {
      const capteur = document.getElementById("capteur").value;
      const container = document.getElementById("grandeur-checkboxes");
      container.innerHTML = '';
      if (capteur === "all") return;
      const data = await loadData();
      const filtered = data.filter(d => d.deviceInfo?.deviceName === capteur);
      const grandeursSet = new Set();

      filtered.forEach(d => {
        if (d.decoded) {
          Object.entries(d.decoded).forEach(([key, val]) => {
            if (typeof val === 'object' && 'value' in val) grandeursSet.add(key);
          });
        }
      });

      grandeursSet.forEach(gr => {
        const div = document.createElement('div');
        div.className = "form-check";
        div.innerHTML = `
          <input type="checkbox" class="form-check-input" id="chk-${gr}" value="${gr}">
          <label class="form-check-label" for="chk-${gr}">${gr}</label>
        `;
        container.appendChild(div);
      });
    }

    function getColor(i) {
      const colors = ['#007bff', '#dc3545', '#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14'];
      return colors[i % colors.length];
    }

    window.onload = async function() {
      try {
        const ctx = document.getElementById('chart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: { datasets: [] },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: { type: 'time' },
              y: { beginAtZero: false }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  title: items => items[0].label,
                  label: context => context.parsed.y
                }
              }
            }
          }
        });
      } catch (e) {
        console.error("√âchec init Chart.js:", e);
      }
      await refreshTable();
      populateCapteursFromCurrentData();
      setInterval(refreshTable, 10000);
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>